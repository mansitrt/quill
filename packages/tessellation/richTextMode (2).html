<!-- Style -->
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<style>
  #toolbar {
    padding: 10px;
    background-color: white;
    border-bottom: 1px solid #ccc;
  }

  #editor {
    border: 1px solid #ccc;
    overflow-y: auto;
    height: calc(100vh - 100px);
    padding-bottom: 10px;
  }

  /*  overflow: auto;*/
  #editor-container {
    display: flex;
    flex-direction: column;
    border: 1px solid #ccc;
    position: relative;
    overflow: hidden;
  }

  .ql-container {
    border: 1px solid transparent !important;
    overflow-y: visible !important;
  }

  .ql-container.ql-snow {
    border: 1px solid transparent !important;
    overflow-y: visible !important;

  }

  .ql-editor.ql-blank:focus::before {
    content: '';
  }

  /* Set content font-families */
  .ql-font-Helvetica {
    font-family: "Helvetica";
  }

  .ql-font-AppleChancery {
    font-family: "Apple-Chancery";
  }

  .ql-font-Papyrus {
    font-family: "Papyrus";
  }

  .ql-font-Rockwell {
    font-family: "Rockwell";
  }

  .ql-font-Optima {
    font-family: "Optima";
  }

  .ql-font-Georgia {
    font-family: "Georgia";
  }

  .ql-font-TimesNewRoman {
    font-family: "Times-New-Roman";
  }

  /* We do not set Sans Serif since it is the default font */
</style>

<!-- Include Quill stylesheet -->
<!--  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />-->
<link href="./quill.snow.css" rel="stylesheet" />
<link href="./quill.min.css" rel="stylesheet" />
<link href="./quill-table.min.css" rel="stylesheet" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<script src="./quill.js"></script>
<script src="./jquery-s.1.4.min.js"></script>
<!-- <script src="quill.min.js"></script> -->
<script src="./quill-table.min.js"></script>

<!-- Create the toolbar container -->

<!-- Create the editor container -->
<div id="editor-container" class="editor-container">
  <div id="toolbar">
    <span class="ql-formats">
      <select class="ql-font" id="fontSelect">
        <option value="Helvetica">Helvetica</option>
        <option value="TimesNewRoman">Times New Roman</option>
        <option value="AppleChancery">Apple Chancery</option>
        <option value="Papyrus">Papyrus</option>
        <option value="Rockwell">Rockwell</option>
        <option value="Optima">Optima</option>
        <option value="Georgia">Georgia</option>
      </select>
    </span>
    <span class="ql-format-seperator"></span>
    <span class="ql-formats">
      <select class="ql-size" id="sizeSelect">
        <option value="10px">10px</option>
        <option value="11px">11px</option>
        <option value="12px">12px</option>
        <option value="14px">14px</option>
        <option value="16px">16px</option>
        <option value="18px">18px</option>
        <option value="20px">20px</option>
        <option value="24px">24px</option>
        <option value="28px">28px</option>
        <option value="36px" id="fontSize36">36px</option>
      </select>
      <button id="insert-table">
        <?xml version="1.0"
        encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
        <svg width="auto" height="auto" viewBox="0 0 24 24" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path
            d="M4 12L20 12M12 4L12 20M6.2 20H17.8C18.9201 20 19.4802 20 19.908 19.782C20.2843 19.5903 20.5903 19.2843 20.782 18.908C21 18.4802 21 17.9201 21 16.8V7.2C21 6.0799 21 5.51984 20.782 5.09202C20.5903 4.71569 20.2843 4.40973 19.908 4.21799C19.4802 4 18.9201 4 17.8 4H6.2C5.0799 4 4.51984 4 4.09202 4.21799C3.71569 4.40973 3.40973 4.71569 3.21799 5.09202C3 5.51984 3 6.07989 3 7.2V16.8C3 17.9201 3 18.4802 3.21799 18.908C3.40973 19.2843 3.71569 19.5903 4.09202 19.782C4.51984 20 5.07989 20 6.2 20Z"
            stroke="#000000" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
      </button>
    </span>
    <span class="ql-formats">
      <button class="ql-bold"></button>
      <button class="ql-italic"></button>
      <button class="ql-underline"></button>
      <button class="ql-strike"></button>
    </span>
    <span class="ql-format-seperator" style="margin-left:-4px;"></span>
    <span class="ql-formats">
      <select class="ql-color"></select>
      <select class="ql-background"></select>
    </span>
    <span class="ql-format-seperator"></span>
    <span class="ql-formats">
      <button class="ql-list" value="ordered"></button>
      <button class="ql-list" value="bullet"></button>
      <select class="ql-align">
        <option label="left" selected></option>
        <option label="center" value="center"></option>
        <option label="right" value="right"></option>
        <option label="justify" value="justify"></option>
      </select>
    </span>

    <!--          <span class="ql-formats">-->
    <!--            <button class="ql-link"></button>-->
    <!--            <button class="ql-image"></button>-->
    <!--            <button class="ql-video"></button>-->
    <!--          </span>-->
    <!--          <span class="ql-formats">-->
    <!--            <button class="ql-formula"></button>-->
    <!--            <button class="ql-code-block"></button>-->
    <!--          </span>-->
    <!--      <span class="ql-formats">-->
    <!--        <button class="ql-script" value="sub"></button>-->
    <!--        <button class="ql-script" value="super"></button>-->
    <!--      </span>-->
    <!--      <span class="ql-formats">-->
    <!--        <button class="ql-clean"></button>-->
    <!--      </span>-->
  </div>
  <div id="editor">
    <p><span id="firstElement" class><span></p>
  </div>
</div>

<script>
  var placeHolderLanguage = 'Enter note content here';
  var keyboardHeight = 0;
  var isTabToEdit = null;
  var isPlanNote = false;
  var belowContentHeight = 0;

  // Add fonts to whitelist
    let Font = Quill.import('formats/font');
    // We do not add Sans Serif since it is the default
    Font.whitelist = [
      'TimesNewRoman',
      'Helvetica',
      'AppleChancery',
      'Papyrus',
      'Rockwell',
      'Optima',
      'Georgia',
    ];
    Quill.register(Font, true);

    var Size = Quill.import('attributors/style/size');
    Size.whitelist = [
      '10px',
      '11px',
      '12px',
      '14px',
      '16px',
      '18px',
      '20px',
      '24px',
      '28px',
      '36px',
    ];
    Quill.register(Size, true);

    // set the default font size
    const sizeSelect = document.getElementById('sizeSelect');
    sizeSelect.value = '14px';

    // set the default font name
    const fontSelect = document.getElementById('fontSelect');
    fontSelect.value = 'Optima';

    Quill.register(
      {
        'modules/tableUI': quillTableUI.default,
      },
      true,
    );

    var snow = new Quill('#editor', {
      theme: 'snow',
      placeholder: `${placeHolderLanguage}`,
      modules: {
        table: true,
        tableUI: true,
        toolbar: '#toolbar'
      }
    });

    const table = snow.getModule('table');
    const editorContainer = document.getElementById('editor-container');
    const editor = document.getElementById('editor');

    document
      .querySelector('#insert-table')
      .addEventListener('click', function () {
        table.insertTable(2, 2);
      });

    // Called each time when text changes in the editor
    const toolbar = document.getElementById('toolbar');
    const toolbarWrapper = document.getElementById('toolbarWrapper');

    let editorHeight = document.getElementById('editor').offsetHeight;
    const selection = () => {
      if (window.getSelection) return window.getSelection();
    };

    snow.on('selection-change', function (range) {
      if (range) {
        if (range.start == range.end) {
          window.webkit.messageHandlers.callbackHandler.postMessage(
            `Toolbar_Visible`,
          );

          if (isTabToEdit) {
            document.getElementById('toolbar').style.display = 'block';
          }
        }
      }
    });
    
    document.addEventListener('scroll', (event) => {
      window.scrollTo(0, 0);
    });
    
    function setupClickToScroll() {
        const parentDiv = document.getElementById('editor');

        if (!parentDiv) {
            console.error(`Div with id "${divId}" not found.`);
            return;
        }

        parentDiv.addEventListener('click', (event) => {
            // Check if the clicked element is a child of the parent div
            if (parentDiv.contains(event.target)) {
                const clickedElement = event.target;

                // If the clicked target is not the parent div itself
                if (clickedElement !== parentDiv) {
                    // Set a timeout to scroll the clicked element into view after 3 seconds
                    setTimeout(() => {
                        clickedElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center', // Center the element in the view
                        });
                    }, 300); // 3 seconds delay
                }
            }
        });
    }
    setupClickToScroll();
    
  
    snow.on('text-change', function (delta, source) {
      sendContentToNativeApp();
    });

  function getQuillHtml() { return snow.root.innerHTML; }
  
  function sendContentToNativeApp() {
      try {
        let html = getQuillHtml();
        window.webkit.messageHandlers.callbackHandler.postMessage(html);
      } catch (err) {
        console.log('The native context does not exist yet');
      }
    }
    
    
    function adjustForKeyboard(keyboardHeight) {
        const toolbar = document.getElementById('toolbar');
        const editor = document.getElementById('editor');
        const editorContainer = document.getElementById('editor-container');
        const toolbarHeight = toolbar.offsetHeight;
        const editorContainerHeight = editorContainer.offsetHeight;

        // If keyboard is open, adjust the height of the editor
        if (keyboardHeight > 0) {
            editor.style.height = "180px";
        } else {
            editor.style.height = `calc(100vh - 100px)`;
        }
    }

  // function isToolbarFullyVisible() {
  //   var $toolbar = $('#toolbar');
  //   var toolbarTop = $toolbar.offset().top;
  //   var toolbarBottom = toolbarTop + $toolbar.outerHeight();
  //   var windowHeight = $(window).height();
  //   return toolbarTop >= 0 && toolbarBottom <= windowHeight;
  // }

  $(window).on('resize', function () {
    if (isToolbarFullyVisible) {
      // window.webkit.messageHandlers.callbackHandler.postMessage('Toolbar_Visible');
    } else {
      // window.webkit.messageHandlers.callbackHandler.postMessage('Toolbar_Not_Visible');
    }
  });


  $("#btnscrollToBottom").click(function () {
    const $editable = $('.ql-editor');
    const height = $editable[0].scrollHeight;

    console.log('scroll height: ', height);

    $editable.animate({
      scrollTop: height
    }, 500);
  });
    
  $("#MakeUIWorkForEdit").click(function () {
    snow.root.scrollTop = 0;
  });

  function scrollToCursor() {
      var range = snow.getSelection();
       if (range) {
         var bounds = snow.getBounds(range.index, range.length);
         snow.root.scrollTop = bounds.top;
       }
   }
    
 
    
   $("#ScrollToCursorPosition").click(function () {
     scrollToCursor();
   });

  // function getTextOfRichTextEditorSave() {
  //   snow.root.blur();
  //   snow.enable(false);
  //   return snow.root.innerHTML;
  // }

  function disabledRichTextContainer() {
    snow.enable(false);
    isTabToEdit = false;

    document.getElementById('toolbar').style.display = 'none';
    document.querySelector('#editor-container .ql-container.ql-snow').style.height = '100%';
  
  }
    
       
  function enabledRichTextContainer() {
    isPlanNote = false;
    snow.enable(true);
    document.getElementById('toolbar').style.display = 'none';
    isTabToEdit = true;
    document.querySelector('#editor-container .ql-container.ql-snow').style.height = '95%';
  }
       
  // function getTextOfRichTextEditorEdit() {
  //   snow.enable(true);
  //   const root = snow.root;
  //   const selectionPosition = Math.round(root.scrollTop / (root.scrollHeight - root.clientHeight) * snow.getLength());
  //   snow.setSelection(selectionPosition || 0);
  //   document.getElementById('toolbar').style.display = 'block';

           
  //   setTimeout(() => {
  //     if(document.getElementById('toolbar').style.display != 'none') {
  //       document.getElementById('editor').style.height = `${editorHeight + Number(belowContentHeight) - Number(keyboardHeight)}px`;
  //     }
  //     snow.focus();
  //     toolbar.scrollIntoView();
  //   }, 100)
  // }

  // async function setkeyboardScroll() {
  //   const range = snow.getSelection();
  //   await snow.blur();
  //   await snow.setSelection(range.index, range.length);
  //   await toolbar.scrollIntoView();
  // }

  // Call this function when the font and size values are received from Swift
  // function setDefaults(fontName, fontSize) {
  //   initializeEditor(fontName, fontSize);
  // }

  function changeThePlaceHolder(newPlaceholder) {
    snow.root.setAttribute('data-placeholder', `${newPlaceholder}`);
  }
  
</script>
